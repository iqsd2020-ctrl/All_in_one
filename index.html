<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>تطبيقاتي</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="https://raw.githubusercontent.com/iqsd2020-ctrl/All_in_one/refs/heads/main/app-drawer.png">
    
    <!-- مكاتب التصميم -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #ffffff; user-select: none; -webkit-tap-highlight-color: transparent; }
        /* ألوان جوجل بلاي */
        .text-play { color: #01875f; }
        .bg-play { background-color: #01875f; }
        .btn-press:active { transform: scale(0.97); opacity: 0.9; }
        
        /* إخفاء شريط التمرير */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* تنسيق الحقول */
        .input-field { width: 100%; background: #f8f9fa; border: 1px solid #dadce0; padding: 12px; border-radius: 8px; outline: none; transition: all 0.2s; }
        .input-field:focus { border-color: #01875f; background: #fff; box-shadow: 0 1px 4px rgba(1,135,95,0.2); }
    </style>

    <!-- كود التطبيق والاتصال -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getFirestore, doc, addDoc, deleteDoc, updateDoc, onSnapshot, collection, query, orderBy, increment, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- 1. إعدادات مشروعك بدقة ---
        const firebaseConfig = {
            apiKey: "AIzaSyDY1FNxvECtaV_dflCzkRH4pHQi_HQ4fwA",
            authDomain: "all-in-b0422.firebaseapp.com",
            projectId: "all-in-b0422",
            storageBucket: "all-in-b0422.firebasestorage.app",
            messagingSenderId: "347315641241",
            appId: "1:347315641241:web:a582acb160c2b603031108",
            measurementId: "G-W77R09ZTP5"
        };

        // تهيئة المتغيرات
        let app, db, auth;
        let currentUser = null;
        let isAdmin = false;
        const ADMIN_PHONE = "07828937302";
        const ADMIN_PIN = "1420";
        
        // بدء التشغيل ومحاولة الاتصال
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            // مراقبة حالة الاتصال وتشخيص الأخطاء
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    document.getElementById('statusMsg').classList.add('hidden'); // إخفاء رسالة الخطأ
                    loadApps(); // تحميل التطبيقات
                    loadStats(); // تحميل الزوار
                } else {
                    signInAnonymously(auth).catch(handleAuthError);
                }
            });
        } catch (e) {
            showError("خطأ فادح في التهيئة: " + e.message);
        }

        function handleAuthError(error) {
            console.error("Auth Error:", error);
            let msg = "مشكلة في الاتصال: " + error.message;
            if (error.code === 'auth/operation-not-allowed') {
                msg = "تنبيه هام: يجب تفعيل خيار (Anonymous) في قائمة Authentication في لوحة تحكم Firebase.";
            }
            showError(msg);
        }

        function showError(msg) {
            const el = document.getElementById('statusMsg');
            el.classList.remove('hidden');
            el.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> ${msg}`;
        }

        // --- 2. تحميل البيانات ---
        function loadApps() {
            const q = query(collection(db, "apps"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                const grid = document.getElementById('appsGrid');
                grid.innerHTML = ''; // تنظيف
                
                if (snapshot.empty) {
                    document.getElementById('emptyState').classList.remove('hidden');
                    return;
                }
                document.getElementById('emptyState').classList.add('hidden');

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    createAppCard(doc.id, data);
                });
            }, (error) => {
                if (error.code === 'permission-denied') {
                    showError("خطأ صلاحيات: تأكد من تحديث الـ Rules في Firestore إلى 'allow read, write: if true;' مؤقتاً أو 'if request.auth != null;'");
                } else {
                    showError("خطأ في تحميل البيانات: " + error.message);
                }
            });
        }

        function loadStats() {
            const docRef = doc(db, "system", "stats");
            // تحديث الزوار مرة واحدة بالجلسة لتقليل الكتابة
            if (!sessionStorage.getItem('visited')) {
                updateDoc(docRef, { visitors: increment(1) }).catch(() => {}); // تجاهل الخطأ إذا لم يوجد المستند
                sessionStorage.setItem('visited', 'true');
            }
            
            onSnapshot(docRef, (doc) => {
                if(doc.exists()) document.getElementById('visitorCount').innerText = doc.data().visitors || 0;
            });
        }

        // --- 3. الرسم والعرض (DOM) ---
        function createAppCard(id, app) {
            const grid = document.getElementById('appsGrid');
            const div = document.createElement('div');
            div.className = "flex flex-col gap-2 cursor-pointer group active:scale-95 transition-transform";
            
            // التحقق من الصورة
            const isIcon = app.icon && app.icon.startsWith('fa');
            const imgHtml = isIcon 
                ? `<div class="w-full h-full bg-play text-white flex items-center justify-center text-4xl"><i class="${app.icon}"></i></div>` 
                : `<img src="${app.icon}" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/150?text=Error'">`;

            div.innerHTML = `
                <div class="aspect-square rounded-2xl shadow-sm border border-gray-100 bg-gray-50 overflow-hidden relative">
                    ${imgHtml}
                    ${app.type === 'movie' ? '<div class="absolute inset-0 bg-black/30 flex items-center justify-center"><i class="fa-solid fa-play text-white text-2xl"></i></div>' : ''}
                </div>
                <div>
                    <h3 class="text-xs font-bold text-gray-900 line-clamp-1">${app.name}</h3>
                    <p class="text-[10px] text-gray-500 truncate">${app.dev}</p>
                </div>
            `;
            
            // عند النقر
            div.onclick = () => openDetails(id, app);
            grid.appendChild(div);
        }

        // --- 4. الوظائف العامة (Global Functions) ---
        window.openDetails = (id, app) => {
            const modal = document.getElementById('detailsModal');
            
            // تعبئة البيانات
            document.getElementById('dName').innerText = app.name;
            document.getElementById('dDev').innerText = app.dev;
            document.getElementById('dDesc').innerText = app.desc || "لا يوجد وصف";
            
            // الأيقونة
            const iconCont = document.getElementById('dIcon');
            if(app.icon && app.icon.startsWith('fa')) {
                iconCont.innerHTML = `<div class="w-24 h-24 rounded-2xl bg-play text-white flex items-center justify-center text-4xl shadow-lg"><i class="${app.icon}"></i></div>`;
            } else {
                iconCont.innerHTML = `<img src="${app.icon}" class="w-24 h-24 rounded-2xl shadow-lg object-cover bg-white">`;
            }

            // زر الفتح (إصلاح الرابط)
            const btn = document.getElementById('dOpenBtn');
            btn.innerText = app.type === 'movie' ? "مشاهدة الآن" : "تحميل / فتح";
            btn.onclick = () => {
                if (!app.streamUrl) {
                    alert("عذراً، لم يضع الناشر رابطاً لهذا التطبيق.");
                    return;
                }
                // التأكد من البروتوكول
                let url = app.streamUrl;
                if (!url.startsWith('http')) url = 'https://' + url;
                window.open(url, '_blank');
            };

            // زر الحذف (للمسؤول)
            const delBtn = document.getElementById('dDeleteBtn');
            if (isAdmin) {
                delBtn.classList.remove('hidden');
                delBtn.onclick = async () => {
                    if(confirm("حذف نهائي؟")) {
                        await deleteDoc(doc(db, "apps", id));
                        closeModal('detailsModal');
                    }
                };
            } else {
                delBtn.classList.add('hidden');
            }

            // معرض الصور
            const gallery = document.getElementById('dGallery');
            gallery.innerHTML = '';
            if (app.screenshots && app.screenshots.length > 0) {
                app.screenshots.forEach(src => {
                    const img = document.createElement('img');
                    img.src = src;
                    img.className = "h-48 w-auto rounded-lg border border-gray-200 shadow-sm flex-shrink-0";
                    gallery.appendChild(img);
                });
                gallery.parentElement.classList.remove('hidden');
            } else {
                gallery.parentElement.classList.add('hidden');
            }

            modal.classList.remove('hidden');
        };

        // ضغط الصور (مهم جداً لمنع أخطاء قاعدة البيانات)
        window.processImage = (file, maxWidth) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (ev) => {
                    const img = new Image();
                    img.src = ev.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let w = img.width;
                        let h = img.height;
                        if (w > maxWidth) { h = (maxWidth/w)*h; w = maxWidth; }
                        canvas.width = w;
                        canvas.height = h;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, w, h);
                        // ضغط الجودة إلى 0.6 لتقليل الحجم
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
                reader.onerror = reject;
            });
        };

        window.submitApp = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('pubBtn');
            btn.innerText = "جاري المعالجة...";
            btn.disabled = true;

            try {
                // جمع البيانات
                const name = document.getElementById('iName').value;
                const dev = document.getElementById('iDev').value;
                const desc = document.getElementById('iDesc').value;
                const url = document.getElementById('iUrl').value;
                const type = document.getElementById('iTypeApp').classList.contains('bg-play') ? 'app' : 'movie';
                
                // معالجة الأيقونة
                const iconFile = document.getElementById('iIcon').files[0];
                let finalIcon = type === 'app' ? 'fa-brands fa-android' : 'fa-solid fa-film';
                
                if (iconFile) {
                    // ضغط الأيقونة إلى 150 بكسل
                    finalIcon = await window.processImage(iconFile, 150);
                }

                // معالجة الصور (Screenshots)
                const screenFiles = document.getElementById('iScreens').files;
                let screenshots = [];
                if (screenFiles.length > 0) {
                    for(let i=0; i<Math.min(screenFiles.length, 2); i++) {
                        // ضغط الصور إلى 500 بكسل وبحد أقصى صورتين فقط لتجنب امتلاء المستند
                        const compressed = await window.processImage(screenFiles[i], 500);
                        screenshots.push(compressed);
                    }
                }

                // الإرسال
                await addDoc(collection(db, "apps"), {
                    name, dev, desc, streamUrl: url, type,
                    icon: finalIcon,
                    screenshots: screenshots,
                    createdAt: serverTimestamp()
                });

                alert("تم النشر بنجاح!");
                closeModal('addModal');
                e.target.reset();

            } catch (err) {
                console.error(err);
                alert("فشل النشر: " + err.message + "\n(نصيحة: قلل عدد الصور أو جودتها)");
            } finally {
                btn.innerText = "نشر الآن";
                btn.disabled = false;
            }
        };

        // تسجيل الدخول كمسؤول
        window.login = (e) => {
            e.preventDefault();
            const p = document.getElementById('pPhone').value;
            const c = document.getElementById('pPin').value;
            if (p === ADMIN_PHONE && c === ADMIN_PIN) {
                isAdmin = true;
                document.getElementById('adminPanel').classList.remove('hidden');
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('navAddBtn').classList.remove('hidden'); // إظهار زر الإضافة
            } else {
                alert("بيانات خاطئة");
            }
        };

        // تبديل نوع التطبيق في النموذج
        window.toggleType = (t) => {
            const btnApp = document.getElementById('iTypeApp');
            const btnMov = document.getElementById('iTypeMov');
            if (t === 'app') {
                btnApp.className = "flex-1 py-2 rounded font-bold bg-play text-white transition";
                btnMov.className = "flex-1 py-2 rounded font-bold bg-gray-200 text-gray-600 transition";
                document.getElementById('lUrl').innerText = "رابط التحميل";
            } else {
                btnMov.className = "flex-1 py-2 rounded font-bold bg-play text-white transition";
                btnApp.className = "flex-1 py-2 rounded font-bold bg-gray-200 text-gray-600 transition";
                document.getElementById('lUrl').innerText = "رابط المشاهدة";
            }
        };

        // دوال الواجهة
        window.openModal = (id) => document.getElementById(id).classList.remove('hidden');
        window.closeModal = (id) => document.getElementById(id).classList.add('hidden');
    </script>
</head>
<body class="bg-white h-screen flex flex-col">

    <!-- 1. Header -->
    <header class="h-16 border-b flex items-center justify-between px-4 sticky top-0 bg-white z-20">
        <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/iqsd2020-ctrl/All_in_one/refs/heads/main/app-drawer.png" class="w-8 h-8" alt="Logo">
            <h1 class="text-xl font-bold text-gray-700 hidden sm:block">تطبيقاتي</h1>
        </div>
        
        <!-- Search -->
        <div class="flex-1 max-w-md mx-4 hidden sm:block">
            <input type="text" placeholder="بحث..." class="w-full bg-gray-100 border-none rounded-lg px-4 py-2 focus:ring-2 focus:ring-green-500 outline-none">
        </div>

        <div class="flex items-center gap-3">
            <div class="text-xs bg-gray-50 border px-2 py-1 rounded text-gray-500">
                <i class="fa-solid fa-eye text-play"></i> <span id="visitorCount">..</span>
            </div>
            <button id="navAddBtn" onclick="openModal('addModal')" class="hidden bg-play text-white px-3 py-1.5 rounded-lg text-sm font-bold btn-press">
                <i class="fa-solid fa-plus"></i> نشر
            </button>
            <button onclick="openModal('settingsModal')" class="w-9 h-9 bg-gray-200 rounded-full flex items-center justify-center text-gray-500 hover:bg-gray-300">
                <i class="fa-solid fa-user"></i>
            </button>
        </div>
    </header>

    <!-- Error Status Bar -->
    <div id="statusMsg" class="bg-red-100 text-red-700 px-4 py-3 text-sm font-bold border-b border-red-200 hidden"></div>

    <!-- 2. Main Content -->
    <main class="flex-1 overflow-y-auto p-4">
        
        <!-- Empty State -->
        <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-400">
            <i class="fa-solid fa-box-open text-5xl mb-2"></i>
            <p>لا يوجد تطبيقات منشورة</p>
        </div>

        <!-- Grid -->
        <div id="appsGrid" class="grid grid-cols-3 min-[450px]:grid-cols-4 sm:grid-cols-5 md:grid-cols-6 gap-4 pb-10">
            <!-- يتم توليد البطاقات هنا -->
        </div>
    </main>

    <!-- 3. Modals -->

    <!-- Add Modal -->
    <div id="addModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-md rounded-xl shadow-2xl flex flex-col max-h-[90vh] overflow-hidden animate-[fadeIn_0.2s]">
            <div class="px-4 py-3 border-b flex justify-between font-bold">
                <span>نشر جديد</span>
                <button onclick="closeModal('addModal')" class="text-gray-500"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 overflow-y-auto">
                <form onsubmit="window.submitApp(event)" class="space-y-4">
                    <div class="flex gap-2">
                        <button type="button" id="iTypeApp" onclick="toggleType('app')" class="flex-1 py-2 rounded font-bold bg-play text-white">تطبيق</button>
                        <button type="button" id="iTypeMov" onclick="toggleType('mov')" class="flex-1 py-2 rounded font-bold bg-gray-200 text-gray-600">فيلم</button>
                    </div>
                    
                    <input id="iName" type="text" class="input-field" placeholder="الاسم (مثال: واتساب)" required>
                    <input id="iDev" type="text" class="input-field" placeholder="المطور / الشركة" required>
                    <textarea id="iDesc" class="input-field h-20 resize-none" placeholder="الوصف..."></textarea>
                    
                    <div>
                        <label id="lUrl" class="text-xs font-bold block mb-1">رابط التحميل</label>
                        <input id="iUrl" type="url" class="input-field bg-yellow-50" placeholder="https://..." required>
                    </div>

                    <div class="flex gap-2">
                        <div class="w-1/3">
                            <label class="text-[10px] font-bold block mb-1">الأيقونة</label>
                            <input id="iIcon" type="file" accept="image/*" class="text-xs w-full">
                        </div>
                        <div class="w-2/3">
                            <label class="text-[10px] font-bold block mb-1">لقطات (Max 2)</label>
                            <input id="iScreens" type="file" accept="image/*" multiple class="text-xs w-full">
                        </div>
                    </div>

                    <button id="pubBtn" type="submit" class="w-full bg-play text-white py-3 rounded-lg font-bold btn-press">نشر الآن</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Details Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-white z-50 hidden flex flex-col overflow-y-auto animate-[slideUp_0.3s]">
        <div class="p-4 border-b flex items-center gap-4 sticky top-0 bg-white z-10">
            <button onclick="closeModal('detailsModal')" class="text-gray-600 p-2 bg-gray-100 rounded-full"><i class="fa-solid fa-arrow-right"></i></button>
            <span class="font-bold text-lg">التفاصيل</span>
        </div>
        <div class="p-5 max-w-2xl mx-auto w-full">
            <div class="flex gap-4 mb-6">
                <div id="dIcon" class="shrink-0"></div>
                <div class="pt-1 flex-1">
                    <h1 id="dName" class="text-2xl font-bold mb-1"></h1>
                    <p id="dDev" class="text-play font-bold text-sm mb-3"></p>
                    <button id="dOpenBtn" class="w-full bg-play text-white py-2 rounded-lg font-bold shadow btn-press"></button>
                </div>
            </div>

            <div class="mb-6 hidden">
                <h3 class="font-bold mb-2">لقطات الشاشة</h3>
                <div id="dGallery" class="flex gap-3 overflow-x-auto pb-2"></div>
            </div>

            <div class="bg-gray-50 p-4 rounded-xl border">
                <h3 class="font-bold text-sm mb-2 text-gray-500">نبذة</h3>
                <p id="dDesc" class="text-sm leading-6 text-gray-700 whitespace-pre-wrap"></p>
            </div>

            <button id="dDeleteBtn" class="mt-8 w-full border border-red-500 text-red-500 py-3 rounded-lg font-bold hidden">حذف هذا المحتوى</button>
        </div>
    </div>

    <!-- Settings/Admin Modal -->
    <div id="settingsModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-xs rounded-xl shadow-2xl p-6 text-center">
            <button onclick="closeModal('settingsModal')" class="absolute top-4 left-4 text-gray-400"><i class="fa-solid fa-xmark"></i></button>
            
            <div id="loginForm">
                <i class="fa-solid fa-lock text-3xl text-gray-400 mb-4"></i>
                <h3 class="font-bold mb-4">منطقة المطورين</h3>
                <form onsubmit="window.login(event)" class="space-y-3">
                    <input id="pPhone" type="tel" placeholder="رقم الهاتف" class="input-field text-center" dir="ltr">
                    <input id="pPin" type="password" placeholder="PIN" class="input-field text-center" maxlength="4">
                    <button type="submit" class="w-full bg-gray-800 text-white py-2 rounded-lg font-bold">دخول</button>
                </form>
            </div>

            <div id="adminPanel" class="hidden">
                <i class="fa-solid fa-check-circle text-4xl text-play mb-2"></i>
                <h3 class="font-bold mb-1">مرحباً بك</h3>
                <p class="text-xs text-gray-500 mb-4">صلاحيات المدير مفعلة</p>
                <button onclick="location.reload()" class="w-full border py-2 rounded-lg text-sm text-red-500">تسجيل خروج</button>
            </div>
        </div>
    </div>

</body>
</html>


